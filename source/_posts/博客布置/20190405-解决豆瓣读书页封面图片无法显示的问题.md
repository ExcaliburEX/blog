---
title: 解决豆瓣读书页封面图片无法显示的问题
categories:
  - 博客布置
tags:
  - JavaScript
  - HTML
date: '2019-04-05 15:42:43'
top: false
toc: false
mathjax: false
comments: true
reward: true
abbrlink: 3abef681
---
插件 `hexo-douban` 很好地提供了豆瓣读书、电影、游戏数据的展示页面，但是存在 Safari 浏览器（包括 macOS 和 iOS 系统）下无法显示豆瓣读书中书籍封面图片的问题。联系了插件作者，也看了一下 GitHub 上面 Issues 中大家的讨论，基本上确认是因为 Safari 无法向豆瓣读书给出空 referrer 信息，而被豆瓣防盗链机制阻挡获取书籍封面图片。<!-- more -->

在此之前，插件作者给出了一个解决方案是为豆瓣页面加入：

```
<meta name="referrer" content="never" />
```

这样声明了空 referrer 信息后，确实可以让生成的豆瓣读书页面在 Safari 下显示书籍封面图片。但是存在一个问题就是在生成的三个豆瓣页面无法兼容 busuanzi 的访客统计数据（无法显示数据），所以作者后来就取消了这个修正。

现在使用中还是发现完善的博客内容显示其实高于无谓的访客统计数据，而且 busuanzi 的访客统计其实在 Safari 下并不准确，总访客数每次刷新都会增加而 Chrome 就不会这样，所以就考虑自己加回刚才提及的修正功能，然后放弃 busuanzi 的访客统计（反正文章阅读数有 LeanCloud，访客分析有百度统计）。由于我的豆瓣插件是在 Netlify 上构建时根据插件依赖列表自动下载安装的，所以在本地修改 `hexo-douban` 的文件并不能解决这个问题。

但是如果直接在 `themes/next/layout/_custom/head.swig` 中加入上述语句，就会让所有页面都设置了空 referrer 信息。而我在腾讯云对象存储防盗链设置里拒绝空 referer 的 http 请求，也就是说我在腾讯云对象存储里的图片即使在白名单链接里也是无法显示的。但是如果允许，直接用图片链接就可以获取对象存储里的图片，而且所有空 referer 的请求（无论链接是不是在白名单里）都可以查看图片里，这样就有了对象存储产生大量读取流量和读取请求的风险（一不小心把我的免费额度用完就不好了）。

因此，需要做的就是让页面自动判断是不是豆瓣读书页面，如果是就加载上述 meta 信息，否则就不加载。这样就需要把以下这段代码加入到 `themes/next/layout/_custom/head.swig` 之中：

```js
<script>
  function GetUrlRelativePath() {
    var url = document.location.toString(); //获取当前链接
    var arrUrl = url.split("//");
    var start = arrUrl[1].indexOf("/");
    var relUrl = arrUrl[1].substring(start); //截取从start开始到结尾的所有字符
    if(relUrl.indexOf("?") != -1){
      relUrl = relUrl.split("?")[0];
    }
      return relUrl;
  }
  var relUrl = GetUrlRelativePath()
  if (relUrl.indexOf('/books/')>=0) {  //判断是否为豆瓣读书页面
    document.write('<meta name="referrer" content="never" />');
  }
</script>
```
